<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - AttendanceMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #2563eb;
            --success-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            background-color: var(--gray-50);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .reports-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1.5rem 0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .quick-filters {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 150px;
        }

        .filter-label {
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.875rem;
        }

        .filter-control {
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }

        .filter-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .quick-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            color: white;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            color: white;
        }

        /* Quick Toggles */
        .quick-toggles {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toggle-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            background: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        /* Reports Grid */
        .reports-container {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .reports-toolbar {
            background: var(--gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .export-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Table */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th {
            background: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-900);
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
        }

        .reports-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .reports-table tbody tr:hover {
            background: var(--gray-50);
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-present {
            background: #d1fae5;
            color: var(--success-green);
        }

        .status-absent {
            background: #fee2e2;
            color: var(--danger-red);
        }

        .status-late {
            background: #fed7aa;
            color: var(--warning-orange);
        }

        /* Attendance Rate */
        .attendance-rate {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rate-bar {
            width: 60px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .rate-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .rate-excellent { background: var(--success-green); }
        .rate-good { background: var(--primary-blue); }
        .rate-warning { background: var(--warning-orange); }
        .rate-poor { background: var(--danger-red); }

        /* Charts Container */
        .charts-section {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .summary-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin: 0.5rem 0 0 0;
        }

        .value-present { color: var(--success-green); }
        .value-absent { color: var(--danger-red); }
        .value-late { color: var(--warning-orange); }
        .value-rate { color: var(--primary-blue); }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .reports-toolbar {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .export-actions {
                justify-content: center;
            }
            
            .reports-table {
                font-size: 0.75rem;
            }
            
            .reports-table th,
            .reports-table td {
                padding: 0.5rem;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .reports-header,
            .quick-filters,
            .reports-toolbar {
                display: none;
            }
            
            .reports-container {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="reports-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 style="margin: 0; color: var(--gray-900);">Attendance Reports</h4>
                    <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem;">View and analyze attendance data for your classes</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="/teacher-dashboard" class="quick-btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <!-- Flash Messages -->
        <% if (typeof flash !== 'undefined' && flash && flash.message) { %>
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <%= flash.message %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <!-- Quick Filters -->
        <div class="quick-filters">
            <div class="quick-toggles">
                <button class="toggle-btn active" data-period="today" onclick="setTimePeriod('today')">Today</button>
                <button class="toggle-btn" data-period="week" onclick="setTimePeriod('week')">This Week</button>
                <button class="toggle-btn" data-period="month" onclick="setTimePeriod('month')">This Month</button>
                <button class="toggle-btn" data-period="custom" onclick="setTimePeriod('custom')">Custom Range</button>
            </div>

            <div class="filter-group">
                <div class="filter-item">
                    <label class="filter-label">Class</label>
                    <select class="filter-control" id="classFilter" onchange="applyFilters()">
                        <option value="">All Classes</option>
                        <!-- Classes will be loaded here -->
                    </select>
                </div>
                <div class="filter-item">
                    <label class="filter-label">From Date</label>
                    <input type="date" class="filter-control" id="fromDate" onchange="applyFilters()">
                </div>
                <div class="filter-item">
                    <label class="filter-label">To Date</label>
                    <input type="date" class="filter-control" id="toDate" onchange="applyFilters()">
                </div>
                <div class="filter-item">
                    <button class="quick-btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid" id="summaryCards">
            <!-- Summary cards will be loaded here -->
        </div>

        <!-- Charts Section -->
        <div class="charts-section" id="chartsSection">
            <h5 style="margin-bottom: 1rem; color: var(--gray-900);">
                <i class="fas fa-chart-line me-2"></i>
                Attendance Trends
            </h5>
            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="reports-container">
            <div class="reports-toolbar">
                <div class="search-box">
                    <div class="search-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search students..." onkeyup="filterTable()">
                </div>
                <div class="export-actions">
                    <button class="quick-btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i>
                        Excel
                    </button>
                    <button class="quick-btn btn-secondary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        PDF
                    </button>
                    <button class="quick-btn btn-secondary" onclick="printReport()">
                        <i class="fas fa-print"></i>
                        Print
                    </button>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="reports-table" id="reportsTable">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Roll Number</th>
                            <th>Class</th>
                            <th>Present Days</th>
                            <th>Absent Days</th>
                            <th>Late Days</th>
                            <th>Total Days</th>
                            <th>Attendance Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Table data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentFilters = {
            period: 'today',
            classId: '',
            fromDate: '',
            toDate: ''
        };
        let reportsData = [];
        let attendanceChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadClasses();
            loadReportsData();
        });

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const fromDate = document.getElementById('fromDate');
            const toDate = document.getElementById('toDate');
            
            fromDate.value = today.toISOString().slice(0, 10);
            toDate.value = today.toISOString().slice(0, 10);
            
            currentFilters.fromDate = fromDate.value;
            currentFilters.toDate = toDate.value;
        }

        // Set time period
        function setTimePeriod(period) {
            // Update active button
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            const today = new Date();
            const fromDate = document.getElementById('fromDate');
            const toDate = document.getElementById('toDate');
            
            switch(period) {
                case 'today':
                    fromDate.value = today.toISOString().slice(0, 10);
                    toDate.value = today.toISOString().slice(0, 10);
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    fromDate.value = weekStart.toISOString().slice(0, 10);
                    toDate.value = today.toISOString().slice(0, 10);
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    fromDate.value = monthStart.toISOString().slice(0, 10);
                    toDate.value = today.toISOString().slice(0, 10);
                    break;
                case 'custom':
                    // Let user select custom dates
                    break;
            }
            
            currentFilters.period = period;
            currentFilters.fromDate = fromDate.value;
            currentFilters.toDate = toDate.value;
            
            if (period !== 'custom') {
                applyFilters();
            }
        }

        // Load classes
        async function loadClasses() {
            try {
                const response = await fetch('/api/teacher-classes');
                const data = await response.json();
                
                if (data.success) {
                    const classFilter = document.getElementById('classFilter');
                    classFilter.innerHTML = '<option value="">All Classes</option>' +
                        data.classes.map(cls => 
                            `<option value="${cls.id}">${cls.name} - ${cls.section}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Apply filters
        function applyFilters() {
            currentFilters.classId = document.getElementById('classFilter').value;
            currentFilters.fromDate = document.getElementById('fromDate').value;
            currentFilters.toDate = document.getElementById('toDate').value;
            
            loadReportsData();
        }

        // Load reports data
        async function loadReportsData() {
            try {
                showLoading(true);
                
                const params = new URLSearchParams(currentFilters);
                const response = await fetch(`/api/attendance-reports?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    reportsData = data.reports;
                    updateSummaryCards(data.summary);
                    updateReportsTable(data.reports);
                    updateChart(data.chartData);
                }
            } catch (error) {
                console.error('Error loading reports data:', error);
                showMessage('Error loading reports data', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update summary cards
        function updateSummaryCards(summary) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = `
                <div class="summary-card">
                    <p class="summary-value value-present">${summary.totalPresent || 0}</p>
                    <p class="summary-label">Total Present</p>
                </div>
                <div class="summary-card">
                    <p class="summary-value value-absent">${summary.totalAbsent || 0}</p>
                    <p class="summary-label">Total Absent</p>
                </div>
                <div class="summary-card">
                    <p class="summary-value value-late">${summary.totalLate || 0}</p>
                    <p class="summary-label">Total Late</p>
                </div>
                <div class="summary-card">
                    <p class="summary-value value-rate">${summary.averageRate || 0}%</p>
                    <p class="summary-label">Average Rate</p>
                </div>
            `;
        }

        // Update reports table
        function updateReportsTable(reports) {
            const tbody = document.getElementById('reportsTableBody');
            
            if (!reports || reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem; color: var(--gray-600);">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p>No attendance data found for the selected period</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = reports.map(report => {
                const rate = report.totalDays > 0 ? 
                    Math.round(((report.presentDays + report.lateDays) / report.totalDays) * 100) : 0;
                
                let rateClass = 'rate-poor';
                if (rate >= 90) rateClass = 'rate-excellent';
                else if (rate >= 75) rateClass = 'rate-good';
                else if (rate >= 60) rateClass = 'rate-warning';
                
                let statusClass = 'status-present';
                let statusText = 'Good';
                if (rate < 75) {
                    statusClass = 'status-absent';
                    statusText = 'Low';
                } else if (rate < 90) {
                    statusClass = 'status-late';
                    statusText = 'Average';
                }
                
                return `
                    <tr>
                        <td><strong>${report.studentName}</strong></td>
                        <td>${report.rollNumber || '-'}</td>
                        <td>${report.className} - ${report.section}</td>
                        <td>${report.presentDays}</td>
                        <td>${report.absentDays}</td>
                        <td>${report.lateDays}</td>
                        <td>${report.totalDays}</td>
                        <td>
                            <div class="attendance-rate">
                                <span>${rate}%</span>
                                <div class="rate-bar">
                                    <div class="rate-fill ${rateClass}" style="width: ${rate}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update chart
        function updateChart(chartData) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels || [],
                    datasets: [
                        {
                            label: 'Present',
                            data: chartData.present || [],
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Absent',
                            data: chartData.absent || [],
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Late',
                            data: chartData.late || [],
                            borderColor: '#d97706',
                            backgroundColor: 'rgba(217, 119, 6, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#reportsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Export functions
        function exportToExcel() {
            const params = new URLSearchParams(currentFilters);
            window.open(`/api/export-attendance?format=excel&${params}`, '_blank');
        }

        function exportToPDF() {
            const params = new URLSearchParams(currentFilters);
            window.open(`/api/export-attendance?format=pdf&${params}`, '_blank');
        }

        function printReport() {
            window.print();
        }

        // Loading state
        function showLoading(show) {
            const containers = [
                document.getElementById('summaryCards'),
                document.getElementById('reportsTableBody'),
                document.getElementById('chartsSection')
            ];
            
            containers.forEach(container => {
                if (show) {
                    container.classList.add('loading');
                } else {
                    container.classList.remove('loading');
                }
            });
        }

        // Show message
        function showMessage(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>